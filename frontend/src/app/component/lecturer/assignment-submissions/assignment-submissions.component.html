<app-lecturer-layout>
<div class="assignment-submissions-container">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <button mat-icon-button class="back-button" (click)="goBack()" matTooltip="Back">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="header-info">
        <h1 class="page-title">
          <mat-icon class="title-icon">assignment_turned_in</mat-icon>
          <span *ngIf="!assignmentId || assignmentId === 'all'">My Assignment Submissions</span>
          <span *ngIf="assignmentId && assignmentId !== 'all'">Assignment Submissions</span>
        </h1>
        <p class="page-subtitle" *ngIf="assignment">
          {{ assignment.title }} - {{ assignment.subjectId?.name }} (Batch {{ assignment.batchId?.batchNumber }})
        </p>
      </div>
    </div>
    <div class="header-actions" *ngIf="assignmentId && assignmentId !== 'all'">
      <button 
        mat-raised-button 
        color="primary" 
        (click)="evaluateAllSubmissions()"
        [disabled]="evaluatingAll || loading || statistics?.pending === 0"
        class="action-button">
        <mat-spinner *ngIf="evaluatingAll" diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
        <mat-icon *ngIf="!evaluatingAll">psychology</mat-icon>
        <span *ngIf="!evaluatingAll">Evaluate All ({{ statistics?.pending || 0 }})</span>
        <span *ngIf="evaluatingAll">Evaluating {{ statistics?.pending || 0 }} submissions...</span>
      </button>
      <button 
        mat-raised-button 
        color="accent" 
        (click)="publishAllEvaluations()"
        [disabled]="loading || statistics?.completed === 0"
        class="action-button">
        <mat-icon>publish</mat-icon>
        Publish All
      </button>
    </div>
  </div>

  <!-- Body Content -->
  <div class="content-body">
  <!-- Show All Assignments List -->
  <div *ngIf="!assignmentId || assignmentId === 'all'">
    <div class="assignments-grid" *ngIf="!loading && assignments.length > 0">
      <mat-card *ngFor="let assignment of assignments" class="assignment-card" (click)="viewAssignmentSubmissions(assignment)">
        <mat-card-header>
          <mat-icon mat-card-avatar class="assignment-icon">assignment</mat-icon>
          <mat-card-title>{{ assignment.title }}</mat-card-title>
          <mat-card-subtitle>{{ assignment.subjectId?.name || 'N/A' }}</mat-card-subtitle>
        </mat-card-header>
        
        <mat-card-content>
          <div class="assignment-info">
            <div class="info-row">
              <mat-icon>school</mat-icon>
              <span>{{ assignment.courseId?.name || 'N/A' }}</span>
            </div>
            
            <div class="info-row">
              <mat-icon>groups</mat-icon>
              <span>Batch {{ assignment.batchId?.batchNumber || 'N/A' }}</span>
            </div>

            <div class="info-row">
              <mat-icon>event</mat-icon>
              <span>Due: {{ formatDate(assignment.dueDate) }}</span>
            </div>

            <div class="info-row">
              <mat-icon>grading</mat-icon>
              <span>{{ assignment.questions?.length || 0 }} Questions ({{ assignment.totalMarks || 0 }} marks)</span>
            </div>

            <div class="status-badges">
              <mat-chip 
                class="type-chip"
                [style.background-color]="'#667eea'"
                [style.color]="'white'">
                {{ assignment.type || 'Assignment' }}
              </mat-chip>

              <mat-chip 
                class="level-chip"
                [style.background-color]="'#764ba2'"
                [style.color]="'white'">
                {{ assignment.level || 'intermediate' | titlecase }}
              </mat-chip>

              <mat-chip 
                *ngIf="assignment.isActive"
                class="active-chip">
                <mat-icon>check_circle</mat-icon> Active
              </mat-chip>
            </div>
          </div>
        </mat-card-content>

        <mat-card-actions>
          <button 
            mat-button 
            color="primary"
            (click)="viewAssignmentSubmissions(assignment); $event.stopPropagation()">
            <mat-icon>assignment_turned_in</mat-icon>
            View Submissions
          </button>
        </mat-card-actions>
      </mat-card>
    </div>

    <!-- Empty State for Assignments -->
    <div class="empty-state" *ngIf="!loading && assignments.length === 0">
      <mat-icon class="empty-icon">assignment</mat-icon>
      <h2>No Assignments Found</h2>
      <p>You don't have any assignments assigned to your subjects yet.</p>
    </div>
  </div>

  <!-- Show Specific Assignment Submissions -->
  <div class="statistics-section" *ngIf="statistics && assignmentId && assignmentId !== 'all'">
    <div class="stat-card total">
      <div class="stat-icon">
        <mat-icon>assessment</mat-icon>
      </div>
      <div class="stat-info">
        <h3 class="stat-value">{{ statistics.total }}</h3>
        <p class="stat-label">Total Submissions</p>
      </div>
    </div>

    <div class="stat-card evaluated">
      <div class="stat-icon">
        <mat-icon>check_circle</mat-icon>
      </div>
      <div class="stat-info">
        <h3 class="stat-value">{{ statistics.completed }}</h3>
        <p class="stat-label">Evaluated</p>
      </div>
    </div>

    <div class="stat-card pending">
      <div class="stat-icon">
        <mat-icon>pending</mat-icon>
      </div>
      <div class="stat-info">
        <h3 class="stat-value">{{ statistics.pending }}</h3>
        <p class="stat-label">Pending</p>
      </div>
    </div>

    <div class="stat-card average">
      <div class="stat-icon">
        <mat-icon>trending_up</mat-icon>
      </div>
      <div class="stat-info">
        <h3 class="stat-value">{{ statistics.averagePercentage?.toFixed(1) || 0 }}%</h3>
        <p class="stat-label">Average Score</p>
      </div>
    </div>
  </div>

  <!-- Filters Section - Only show for specific assignment -->
  <mat-card class="filters-card" *ngIf="assignmentId && assignmentId !== 'all'">
    <mat-card-content>
      <form [formGroup]="filterForm" class="filters-form">
        <mat-form-field appearance="outline">
          <mat-label>Search Student</mat-label>
          <input matInput formControlName="search" placeholder="Name, Email, or ID">
          <mat-icon matPrefix>search</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Evaluation Status</mat-label>
          <mat-select formControlName="evaluationStatus">
            <mat-option value="">All</mat-option>
            <mat-option value="pending">Pending</mat-option>
            <mat-option value="evaluating">Evaluating</mat-option>
            <mat-option value="completed">Completed</mat-option>
            <mat-option value="failed">Failed</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Student Level</mat-label>
          <mat-select formControlName="level">
            <mat-option value="">All</mat-option>
            <mat-option value="beginner">Beginner</mat-option>
            <mat-option value="intermediate">Intermediate</mat-option>
            <mat-option value="advanced">Advanced</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Min %</mat-label>
          <input matInput type="number" formControlName="minPercentage" min="0" max="100">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Max %</mat-label>
          <input matInput type="number" formControlName="maxPercentage" min="0" max="100">
        </mat-form-field>

        <button mat-raised-button type="button" (click)="clearFilters()" class="clear-button">
          <mat-icon>clear</mat-icon>
          Clear
        </button>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Submissions Grid - Only show for specific assignment -->
  <div class="submissions-grid" *ngIf="!loading && submissions.length > 0 && assignmentId && assignmentId !== 'all'">
    <mat-card *ngFor="let submission of submissions" class="submission-card" (click)="viewSubmissionDetails(submission)">
      <mat-card-header>
        <div class="student-avatar">
          <mat-icon>person</mat-icon>
        </div>
        <mat-card-title>{{ getStudentName(submission.studentId) }}</mat-card-title>
        <mat-card-subtitle>{{ submission.studentId?.studentId || submission.studentId?.email }}</mat-card-subtitle>
      </mat-card-header>
      
      <mat-card-content>
        <div class="submission-info">
          <div class="info-row">
            <mat-icon>email</mat-icon>
            <span>{{ submission.studentId?.email }}</span>
          </div>
          
          <div class="info-row">
            <mat-icon>event</mat-icon>
            <span>{{ formatDate(submission.submittedAt) }}</span>
          </div>

          <div class="info-row" *ngIf="submission.timeTaken">
            <mat-icon>timer</mat-icon>
            <span>{{ (submission.timeTaken / 60).toFixed(1) }} minutes</span>
          </div>

          <div class="status-badges">
            <mat-chip 
              class="status-chip"
              [class]="getStatusChipClass(submission.evaluationStatus)"
              [style.color]="'white'">
              {{ submission.evaluationStatus | titlecase }}
            </mat-chip>

            <mat-chip 
              *ngIf="submission.level"
              class="level-chip"
              [class]="getLevelChipClass(submission.level)"
              [style.color]="'white'">
              {{ submission.level | titlecase }}
            </mat-chip>
          </div>

          <div class="score-section" *ngIf="submission.totalMarksObtained !== null && submission.totalMarksObtained !== undefined">
            <div class="score-circle" [style.border-color]="getPercentageColor(submission.percentage || 0)">
              <div class="score-value">{{ submission.percentage?.toFixed(1) || 0 }}%</div>
              <div class="score-marks">{{ submission.totalMarksObtained }} / {{ submission.totalMarks }}</div>
            </div>
          </div>

          <!-- Alternative: use 'marks' field if totalMarksObtained doesn't exist -->
          <div class="score-section" *ngIf="(submission.totalMarksObtained === null || submission.totalMarksObtained === undefined) && submission.marks !== null && submission.marks !== undefined">
            <div class="score-circle" [style.border-color]="getPercentageColor(submission.percentage || 0)">
              <div class="score-value">{{ submission.percentage?.toFixed(1) || 0 }}%</div>
              <div class="score-marks">{{ submission.marks }} / {{ assignment.maxMarks }}</div>
            </div>
          </div>
        </div>
      </mat-card-content>

      <mat-card-actions>
        <button 
          mat-button 
          color="primary"
          (click)="viewSubmissionDetails(submission); $event.stopPropagation()">
          <mat-icon>visibility</mat-icon>
          View Details
        </button>
        
        <button 
          mat-button 
          color="accent"
          *ngIf="submission.evaluationStatus === 'pending'"
          (click)="evaluateSubmission(submission._id); $event.stopPropagation()"
          [disabled]="evaluatingSubmission">
          <mat-spinner *ngIf="evaluatingSubmission" diameter="20" style="display: inline-block; margin-right: 4px;"></mat-spinner>
          <mat-icon *ngIf="!evaluatingSubmission">psychology</mat-icon>
          <span *ngIf="!evaluatingSubmission">Evaluate</span>
          <span *ngIf="evaluatingSubmission">Evaluating...</span>
        </button>

        <button 
          mat-button 
          color="primary"
          *ngIf="submission.evaluationStatus === 'completed' && !submission.isPublished"
          (click)="publishEvaluation(submission._id); $event.stopPropagation()">
          <mat-icon>publish</mat-icon>
          Publish
        </button>

        <mat-chip 
          *ngIf="submission.isPublished"
          class="published-chip">
          <mat-icon>check</mat-icon> Published
        </mat-chip>
      </mat-card-actions>
    </mat-card>
  </div>

  <!-- Pagination - Only show for specific assignment -->
  <mat-paginator
    *ngIf="!loading && submissions.length > 0 && assignmentId && assignmentId !== 'all'"
    [length]="totalSubmissions"
    [pageSize]="pageSize"
    [pageSizeOptions]="[5, 10, 25, 50]"
    (page)="onPageChange($event)"
    showFirstLastButtons>
  </mat-paginator>

  <!-- Empty State - Only show for specific assignment -->
  <div class="empty-state" *ngIf="!loading && submissions.length === 0 && assignmentId && assignmentId !== 'all'">
    <mat-icon class="empty-icon">assignment</mat-icon>
    <h2>No Submissions Found</h2>
    <p>There are no submissions matching your criteria.</p>
  </div>

  <!-- Loading State - Only for specific assignment -->
  <div class="loading-state" *ngIf="loading && assignmentId && assignmentId !== 'all'">
    <mat-spinner></mat-spinner>
    <p>Loading submissions...</p>
  </div>

  <!-- Loading State for All View -->
  <div class="loading-state" *ngIf="loading && (!assignmentId || assignmentId === 'all')">
    <mat-spinner></mat-spinner>
    <p>Loading assignments...</p>
  </div>
  </div>
  <!-- End Content Body -->
</div>

<!-- Submission Details Modal -->
<div class="modal-overlay" *ngIf="showSubmissionDetails" (click)="closeSubmissionDetails()">
  <div class="modal-content" (click)="$event.stopPropagation()" *ngIf="selectedSubmission">
    <div class="modal-header">
      <h2>
        <mat-icon>assignment_ind</mat-icon>
        Submission Details
      </h2>
      <button mat-icon-button (click)="closeSubmissionDetails()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="modal-body">
      <!-- Student Info -->
      <mat-card class="detail-card student-info-card">
        <mat-card-header>
          <div mat-card-avatar class="student-avatar-large">
            <mat-icon>person</mat-icon>
          </div>
          <mat-card-title>{{ getStudentName(selectedSubmission.studentId) }}</mat-card-title>
          <mat-card-subtitle>{{ selectedSubmission.studentId?.studentId || selectedSubmission.studentId?.email || 'N/A' }}</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="detail-grid">
            <div class="detail-item">
              <mat-icon>email</mat-icon>
              <div>
                <strong>Email</strong>
                <span>{{ selectedSubmission.studentId?.email || 'N/A' }}</span>
              </div>
            </div>
            <div class="detail-item">
              <mat-icon>school</mat-icon>
              <div>
                <strong>Course</strong>
                <span>{{ selectedSubmission.studentId?.course?.name || 'N/A' }}</span>
              </div>
            </div>
            <div class="detail-item">
              <mat-icon>event</mat-icon>
              <div>
                <strong>Submitted At</strong>
                <span>{{ formatDate(selectedSubmission.submittedAt) }}</span>
              </div>
            </div>
            <div class="detail-item" *ngIf="selectedSubmission.timeTaken">
              <mat-icon>timer</mat-icon>
              <div>
                <strong>Time Taken</strong>
                <span>{{ (selectedSubmission.timeTaken / 60).toFixed(1) }} minutes</span>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Evaluation Results -->
      <mat-card class="detail-card" *ngIf="selectedSubmission.evaluationStatus === 'completed'">
        <mat-card-header>
          <mat-icon mat-card-avatar>grade</mat-icon>
          <mat-card-title>Evaluation Results</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="evaluation-summary">
            <div class="eval-stat">
              <div class="eval-label">Score</div>
              <div class="eval-value">{{ selectedSubmission.marks || 0 }} / {{ assignment.maxMarks || 0 }}</div>
            </div>
            <div class="eval-stat">
              <div class="eval-label">Percentage</div>
              <div class="eval-value" [style.color]="getPercentageColor(selectedSubmission.percentage || 0)">
                {{ selectedSubmission.percentage?.toFixed(1) || 0 }}%
              </div>
            </div>
            <div class="eval-stat">
              <div class="eval-label">Level</div>
              <mat-chip 
                class="eval-level-chip"
                [class]="getLevelChipClass(selectedSubmission.level || 'beginner')"
                [style.color]="'white'">
                {{ (selectedSubmission.level || 'beginner') | titlecase }}
              </mat-chip>
            </div>
          </div>

          <div class="feedback-section" *ngIf="selectedSubmission.feedback">
            <h4><mat-icon>feedback</mat-icon> Feedback</h4>
            <p>{{ selectedSubmission.feedback }}</p>
          </div>

          <div class="grading-info" *ngIf="selectedSubmission.evaluatedAt">
            <mat-icon>access_time</mat-icon>
            <span>Graded on {{ formatDate(selectedSubmission.evaluatedAt) }}</span>
            <mat-icon *ngIf="selectedSubmission.isAutoEvaluated">smart_toy</mat-icon>
            <span *ngIf="selectedSubmission.isAutoEvaluated">(AI Evaluated)</span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Question-Answer Details -->
      <mat-card class="detail-card">
        <mat-card-header>
          <mat-icon mat-card-avatar>quiz</mat-icon>
          <mat-card-title>Questions & Answers</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="answers-list">
            <div 
              *ngFor="let answer of selectedSubmission.submittedAnswers; let i = index" 
              class="answer-item"
              [class.correct-answer]="answer.isCorrect"
              [class.incorrect-answer]="answer.isCorrect === false">
              <div class="answer-header">
                <div class="question-number">
                  <mat-icon>help_outline</mat-icon>
                  <span>Question {{ i + 1 }}</span>
                </div>
                <div class="answer-badges">
                  <mat-chip 
                    *ngIf="answer.isCorrect !== undefined && answer.isCorrect !== null"
                    [style.background-color]="answer.isCorrect ? '#48bb78' : '#f56565'"
                    [style.color]="'white'">
                    <mat-icon>{{ answer.isCorrect ? 'check_circle' : 'cancel' }}</mat-icon>
                    {{ answer.isCorrect ? 'Correct' : 'Incorrect' }}
                  </mat-chip>
                  <mat-chip 
                    *ngIf="answer.marksAwarded !== undefined && answer.marksAwarded !== null" 
                    class="marks-chip"
                    [style.background-color]="'#667eea'"
                    [style.color]="'white'">
                    <mat-icon>grade</mat-icon>
                    {{ answer.marksAwarded }} / {{ answer.questionDetails?.marks || 0 }} marks
                  </mat-chip>
                </div>
              </div>
              <div class="answer-content">
                <div class="question-section">
                  <div class="section-header">
                    <mat-icon>question_answer</mat-icon>
                    <strong>Question</strong>
                  </div>
                  <p class="question-text">{{ answer.questionText || 'Question text not available' }}</p>
                  
                  <mat-chip class="type-chip" *ngIf="answer.type">
                    <mat-icon>category</mat-icon>
                    {{ answer.type }}
                  </mat-chip>
                  
                  <!-- MCQ Options -->
                  <div *ngIf="answer.type === 'MCQ' && answer.questionDetails?.options && answer.questionDetails.options.length > 0" class="mcq-options">
                    <div *ngFor="let option of answer.questionDetails.options; let idx = index" 
                         class="option-item"
                         [class.correct-option]="option.isCorrect"
                         [class.selected-option]="answer.selectedOption === option.option">
                      <span class="option-label">{{ String.fromCharCode(65 + idx) }}.</span>
                      <span class="option-text">{{ option.option }}</span>
                      <mat-icon *ngIf="option.isCorrect" class="correct-icon">check_circle</mat-icon>
                      <mat-icon *ngIf="!option.isCorrect && answer.selectedOption === option.option" class="wrong-icon">cancel</mat-icon>
                    </div>
                  </div>
                </div>
                <div class="student-answer-section">
                  <div class="section-header">
                    <mat-icon>create</mat-icon>
                    <strong>Student's Answer</strong>
                  </div>
                  <p class="student-answer">{{ answer.answer || answer.selectedOption || 'No answer provided' }}</p>
                </div>
                <div *ngIf="answer.feedback" class="question-feedback">
                  <div class="section-header">
                    <mat-icon>feedback</mat-icon>
                    <strong>Feedback</strong>
                  </div>
                  <p>{{ answer.feedback }}</p>
                </div>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <div class="modal-footer">
      <button 
        mat-raised-button 
        color="accent"
        *ngIf="selectedSubmission.evaluationStatus === 'pending'"
        (click)="evaluateSubmission(selectedSubmission._id)"
        [disabled]="evaluatingSubmission">
        <mat-spinner *ngIf="evaluatingSubmission" diameter="20" style="display: inline-block; margin-right: 8px;"></mat-spinner>
        <mat-icon *ngIf="!evaluatingSubmission">psychology</mat-icon>
        <span *ngIf="!evaluatingSubmission">Evaluate with AI</span>
        <span *ngIf="evaluatingSubmission">Evaluating...</span>
      </button>

      <button 
        mat-raised-button 
        color="primary"
        *ngIf="selectedSubmission.evaluationStatus === 'completed' && !selectedSubmission.isPublished"
        (click)="publishEvaluation(selectedSubmission._id)">
        <mat-icon>publish</mat-icon>
        Publish Results
      </button>

      <button mat-button (click)="closeSubmissionDetails()">
        Close
      </button>
    </div>
  </div>
</div>
</app-lecturer-layout>
