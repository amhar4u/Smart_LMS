<app-student-layout>
  <!-- Dashboard Content -->
  <div class="dashboard-content">
    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-container">
      <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      <p>Loading your dashboard...</p>
    </div>

    <!-- Main Content -->
    <div *ngIf="!isLoading">
      <!-- Page Header -->
      <div class="page-header">
        <div class="header-content">
          <div class="header-text">
            <h1>Student Dashboard</h1>
            <p>Welcome back, {{ currentUser?.name }}! Here's your academic overview.</p>
          </div>
          <button mat-raised-button color="primary" (click)="refreshData()">
            <mat-icon>refresh</mat-icon>
            Refresh
          </button>
        </div>
      </div>
      
      <!-- Stats Cards -->
      <div class="stats-grid">
        <mat-card *ngFor="let stat of dashboardStats" 
                  class="stat-card" 
                  [style.border-left]="'4px solid ' + stat.color"
                  (click)="navigateToPage(stat.route)">
          <mat-card-content>
            <div class="stat-content">
              <div class="stat-icon" [style.background-color]="stat.color">
                <mat-icon>{{ stat.icon }}</mat-icon>
              </div>
              <div class="stat-info">
                <h2>{{ stat.value }}</h2>
                <p>{{ stat.title }}</p>
                <span class="stat-subtitle">{{ stat.subtitle }}</span>
                <span class="stat-growth" [style.color]="stat.color">{{ stat.growth }}</span>
              </div>
            </div>
            <div class="stat-progress">
              <mat-progress-bar 
                mode="determinate" 
                [value]="getProgressPercentage(stat)"
                [color]="'primary'">
              </mat-progress-bar>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Next Assignments Table -->
      <mat-card class="table-card">
        <mat-card-header class="table-header">
          <div class="header-with-action">
            <div class="header-title">
              <mat-icon>assignment</mat-icon>
              <mat-card-title>Next 3 Upcoming Assignments</mat-card-title>
            </div>
            <button mat-raised-button color="primary" routerLink="/student/assignments">
              <mat-icon>open_in_new</mat-icon>
              View All
            </button>
          </div>
        </mat-card-header>
        <mat-card-content>
          <div *ngIf="!studentDashboardStats?.nextAssignments?.length" class="no-data">
            <mat-icon>assignment</mat-icon>
            <p>No upcoming assignments</p>
          </div>
          <div *ngIf="studentDashboardStats?.nextAssignments?.length" class="table-container">
            <table mat-table [dataSource]="studentDashboardStats?.nextAssignments || []" class="assignments-table">
              <!-- Subject Column -->
              <ng-container matColumnDef="subject">
                <th mat-header-cell *matHeaderCellDef>Subject</th>
                <td mat-cell *matCellDef="let assignment">
                  <div class="subject-cell">
                    <mat-icon class="subject-icon">subject</mat-icon>
                    <span>{{ getSubjectName(assignment.subjectId) }}</span>
                  </div>
                </td>
              </ng-container>

              <!-- Title Column -->
              <ng-container matColumnDef="title">
                <th mat-header-cell *matHeaderCellDef>Assignment Title</th>
                <td mat-cell *matCellDef="let assignment">
                  <div class="title-cell">
                    <strong>{{ assignment.title }}</strong>
                    <div class="assignment-badges">
                      <span class="badge badge-type">{{ assignment.type || 'Assignment' }}</span>
                      <span class="badge" [ngClass]="getAssignmentLevelBadgeClass(assignment.level)">
                        {{ assignment.level || 'Medium' }}
                      </span>
                    </div>
                  </div>
                </td>
              </ng-container>

              <!-- Modules Column -->
              <ng-container matColumnDef="modules">
                <th mat-header-cell *matHeaderCellDef>Modules</th>
                <td mat-cell *matCellDef="let assignment">
                  <div class="modules-cell">
                    <mat-chip-set>
                      <mat-chip *ngFor="let module of assignment.modules?.slice(0, 2)">
                        {{ typeof module === 'string' ? module : module?.name }}
                      </mat-chip>
                      <mat-chip *ngIf="assignment.modules?.length > 2">
                        +{{ assignment.modules.length - 2 }}
                      </mat-chip>
                    </mat-chip-set>
                  </div>
                </td>
              </ng-container>

              <!-- Total Marks Column -->
              <ng-container matColumnDef="totalMarks">
                <th mat-header-cell *matHeaderCellDef>Total Marks</th>
                <td mat-cell *matCellDef="let assignment">
                  <div class="marks-cell">
                    <span class="marks-value">{{ assignment.totalMarks || 0 }}</span>
                  </div>
                </td>
              </ng-container>

              <!-- Due Date Column -->
              <ng-container matColumnDef="dueDate">
                <th mat-header-cell *matHeaderCellDef>Due Date</th>
                <td mat-cell *matCellDef="let assignment">
                  <div class="date-cell">
                    <mat-icon>event</mat-icon>
                    <span>{{ formatDate(assignment.dueDate) }}</span>
                  </div>
                </td>
              </ng-container>

              <!-- Days Remaining Column -->
              <ng-container matColumnDef="daysRemaining">
                <th mat-header-cell *matHeaderCellDef>Days Left</th>
                <td mat-cell *matCellDef="let assignment">
                  <div class="days-cell">
                    <span class="days-badge" [ngClass]="getDaysRemainingClass(assignment.daysRemaining)">
                      <mat-icon>schedule</mat-icon>
                      {{ getDaysRemainingText(assignment.daysRemaining) }}
                    </span>
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="assignmentColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: assignmentColumns;" class="assignment-row"></tr>
            </table>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Recent Meetings Table -->
      <mat-card class="table-card">
        <mat-card-header class="table-header">
          <div class="header-with-action">
            <div class="header-title">
              <mat-icon>video_call</mat-icon>
              <mat-card-title>Recent 3 Meetings</mat-card-title>
            </div>
            <button mat-raised-button color="primary" routerLink="/student/meetings">
              <mat-icon>open_in_new</mat-icon>
              View All
            </button>
          </div>
        </mat-card-header>
        <mat-card-content>
          <div *ngIf="!studentDashboardStats?.recentMeetings?.length" class="no-data">
            <mat-icon>video_call</mat-icon>
            <p>No recent meetings</p>
          </div>
          <div *ngIf="studentDashboardStats?.recentMeetings?.length" class="table-container">
            <table mat-table [dataSource]="studentDashboardStats?.recentMeetings || []" class="meetings-table">
              <!-- Subject Column -->
              <ng-container matColumnDef="subject">
                <th mat-header-cell *matHeaderCellDef>Subject</th>
                <td mat-cell *matCellDef="let meeting">
                  <div class="subject-cell">
                    <mat-icon class="subject-icon">subject</mat-icon>
                    <span>{{ getSubjectName(meeting.subjectId) }}</span>
                  </div>
                </td>
              </ng-container>

              <!-- Topic Column -->
              <ng-container matColumnDef="topic">
                <th mat-header-cell *matHeaderCellDef>Topic / Link</th>
                <td mat-cell *matCellDef="let meeting">
                  <div class="topic-cell">
                    <strong>{{ meeting.topic || 'No topic' }}</strong>
                    <a *ngIf="meeting.meetingLink" 
                       [href]="meeting.meetingLink" 
                       target="_blank" 
                       class="meeting-link"
                       (click)="$event.stopPropagation()">
                      <mat-icon>link</mat-icon>
                      Join Meeting
                    </a>
                  </div>
                </td>
              </ng-container>

              <!-- Meeting Date Column -->
              <ng-container matColumnDef="meetingDate">
                <th mat-header-cell *matHeaderCellDef>Date & Time</th>
                <td mat-cell *matCellDef="let meeting">
                  <div class="datetime-cell">
                    <mat-icon>event</mat-icon>
                    <span>{{ formatDateTime(meeting.meetingDate, meeting.meetingTime) }}</span>
                  </div>
                </td>
              </ng-container>

              <!-- Duration Column -->
              <ng-container matColumnDef="duration">
                <th mat-header-cell *matHeaderCellDef>Duration</th>
                <td mat-cell *matCellDef="let meeting">
                  <div class="duration-cell">
                    <mat-icon>timer</mat-icon>
                    <span>{{ formatDuration(meeting.duration) }}</span>
                  </div>
                </td>
              </ng-container>

              <!-- Status Column -->
              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef>Status</th>
                <td mat-cell *matCellDef="let meeting">
                  <div class="status-cell">
                    <span class="status-badge" 
                          [style.background-color]="getMeetingStatusColor(meeting.status)"
                          [matTooltip]="meeting.status">
                      {{ meeting.status || 'Scheduled' }}
                    </span>
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="meetingColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: meetingColumns;" class="meeting-row"></tr>
            </table>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</app-student-layout>
