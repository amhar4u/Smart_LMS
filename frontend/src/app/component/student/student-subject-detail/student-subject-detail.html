<app-student-layout>
  <div class="subject-detail-container">
    <!-- Loading State -->
    <div *ngIf="isLoading" class="loading-container">
      <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      <p>Loading subject details...</p>
    </div>

    <!-- Subject Detail Content -->
    <div *ngIf="!isLoading && subject" class="subject-detail-content">
      <!-- Subject Header Card -->
      <div class="subject-header-card">
        <div class="subject-header-content">
          <div class="subject-title-row">
            <h1>{{ subject.name }}</h1>
            <div class="subject-code-badge">{{ subject.code }}</div>
          </div>
          <div class="subject-meta-row">
            <div class="meta-item">
              <mat-icon>school</mat-icon>
              <span>{{ subject.department?.name || 'Department' }} • {{ subject.course?.name || 'Course' }} • {{ subject.batch?.name || 'Batch' }} • {{ subject.semester?.name || 'Semester' }}</span>
            </div>
            <div class="meta-item">
              <mat-icon>credit_card</mat-icon>
              <span>{{ subject.creditHours }} Credits</span>
            </div>
            <div class="meta-item" *ngIf="subject.lecturer">
              <mat-icon>person</mat-icon>
              <span>Lecturer: {{ subject.lecturer.name }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs Section -->
      <mat-tab-group class="subject-tabs" animationDuration="300ms">
        <!-- Modules Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon>book</mat-icon>
            <span>Modules</span>
            <span class="tab-count">{{ subject.modules?.length || 0 }}</span>
          </ng-template>
          <div class="tab-content">
            <div *ngIf="subject.modules && subject.modules.length > 0">
              <mat-accordion class="modules-accordion" multi>
                <mat-expansion-panel *ngFor="let m of subject.modules" class="module-panel" [expanded]="true">
                  <mat-expansion-panel-header>
                    <mat-panel-title>
                      <div class="module-title">
                        <span class="module-number">Week {{ m.moduleNumber }}</span>
                        <span class="module-name">{{ m.name }}</span>
                      </div>
                    </mat-panel-title>
                    <mat-panel-description>
                      <div class="module-badges">
                        <mat-chip *ngIf="m.documents && m.documents.length">
                          <mat-icon>picture_as_pdf</mat-icon> PDF
                        </mat-chip>
                        <mat-chip *ngIf="m.video && m.video.cloudinaryURL">
                          <mat-icon>play_circle</mat-icon> Video
                        </mat-chip>
                      </div>
                    </mat-panel-description>
                  </mat-expansion-panel-header>

                  <!-- Module Body -->
                  <div class="module-body">
                    <p class="module-description">{{ m.description }}</p>

                    <!-- Resources Section -->
                    <div class="resources-section" *ngIf="(m.documents && m.documents.length) || (m.video && m.video.cloudinaryURL)">
                      <h4><mat-icon>folder_open</mat-icon> Resources</h4>
                      <div class="resource-list">
                        <!-- Video Resource (show first if exists) -->
                        <div *ngIf="m.video && m.video.cloudinaryURL" class="resource-item">
                          <button (click)="openVideoPlayer(m.video.cloudinaryURL, m.name + ' - Video')" mat-raised-button color="accent" class="resource-button video">
                            <mat-icon>play_circle</mat-icon>
                            <span>Play Video</span>
                          </button>
                          <a [href]="m.video.cloudinaryURL" download mat-raised-button class="resource-button download">
                            <mat-icon>download</mat-icon>
                            <span>Download</span>
                          </a>
                        </div>
                        
                        <!-- Document Resources -->
                        <div *ngFor="let doc of m.documents || []" class="resource-item">
                          <button (click)="openPdfViewer(doc.cloudinaryURL, doc.name)" mat-raised-button color="primary" class="resource-button doc">
                            <mat-icon>visibility</mat-icon>
                            <span>View {{ doc.name }}</span>
                          </button>
                          <a [href]="doc.cloudinaryURL" download mat-raised-button class="resource-button download">
                            <mat-icon>download</mat-icon>
                            <span>Download</span>
                          </a>
                        </div>
                      </div>
                    </div>

                    <div *ngIf="(!m.documents || !m.documents.length) && (!m.video || !m.video.cloudinaryURL)" class="no-resources">
                      <mat-icon>info</mat-icon>
                      <p>No resources available for this module yet.</p>
                    </div>
                  </div>
                </mat-expansion-panel>
              </mat-accordion>
            </div>
            <div *ngIf="!subject.modules || subject.modules.length === 0" class="empty-state">
              <mat-icon>book</mat-icon>
              <h3>No Modules Yet</h3>
              <p>Modules will appear here once they are added to this subject.</p>
            </div>
          </div>
        </mat-tab>

        <!-- Assignments Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon>assignment</mat-icon>
            <span>Assignments</span>
            <span class="tab-count">{{ subject.allAssignments?.length || 0 }}</span>
          </ng-template>
          <div class="tab-content">
            <div *ngIf="subject.allAssignments && subject.allAssignments.length > 0" class="assignment-list">
              <mat-accordion multi>
                <mat-expansion-panel *ngFor="let assignment of subject.allAssignments" 
                                     class="assignment-accordion"
                                     [class.submitted]="assignment.hasSubmitted"
                                     [class.overdue]="getDaysRemaining(assignment.dueDate) < 0 && !assignment.hasSubmitted"
                                     [expanded]="true">
                  
                  <!-- Accordion Header -->
                  <mat-expansion-panel-header class="assignment-accordion-header">
                    <mat-panel-title class="assignment-panel-title">
                      <div class="assignment-title-compact">
                        <mat-icon class="title-icon">assignment</mat-icon>
                        <div class="title-content">
                          <h3 class="assignment-title-text">{{ assignment.title }}</h3>
                          <p class="assignment-subtitle">{{ assignment.description }}</p>
                        </div>
                      </div>
                    </mat-panel-title>
                    
                    <mat-panel-description class="assignment-panel-description">
                      <div class="assignment-quick-info">
                        <span class="quick-badge badge-level" [ngClass]="'level-' + (assignment.level || 'medium')">
                          <mat-icon>trending_up</mat-icon>
                          {{ assignment.level || 'Medium' }}
                        </span>
                        <span class="quick-badge badge-type" [ngClass]="'type-' + (assignment.type || 'MCQ')">
                          <mat-icon>quiz</mat-icon>
                          {{ assignment.type || 'MCQ' }}
                        </span>
                        <span class="quick-badge badge-status" 
                              [ngClass]="assignment.hasSubmitted ? 'status-submitted' : 
                                        (getDaysRemaining(assignment.dueDate) < 0 ? 'status-overdue' : 'status-pending')">
                          <mat-icon>{{ assignment.hasSubmitted ? 'check_circle' : (getDaysRemaining(assignment.dueDate) < 0 ? 'error' : 'schedule') }}</mat-icon>
                          {{ assignment.hasSubmitted ? 'Submitted' : (getDaysRemaining(assignment.dueDate) < 0 ? 'Overdue' : 'Pending') }}
                        </span>
                        <span class="quick-info-text due-date-quick" 
                              [ngClass]="getDaysRemainingClass(getDaysRemaining(assignment.dueDate))">
                          <mat-icon>schedule</mat-icon>
                          Due: {{ formatDate(assignment.dueDate) }}
                        </span>
                      </div>
                    </mat-panel-description>
                  </mat-expansion-panel-header>

                  <!-- Accordion Body -->
                  <div class="assignment-accordion-body">
                    <!-- Assignment Details Grid -->
                    <div class="assignment-details-grid">
                      <div class="detail-item">
                        <mat-icon>grade</mat-icon>
                        <div class="detail-content">
                          <span class="detail-label">Total Marks</span>
                          <span class="detail-value">{{ assignment.totalMarks || 0 }}</span>
                        </div>
                      </div>

                      <div class="detail-item">
                        <mat-icon>event</mat-icon>
                        <div class="detail-content">
                          <span class="detail-label">Start Date</span>
                          <span class="detail-value">{{ formatDate(assignment.startDate) }}</span>
                        </div>
                      </div>

                      <div class="detail-item" [ngClass]="getDaysRemainingClass(getDaysRemaining(assignment.dueDate))">
                        <mat-icon>schedule</mat-icon>
                        <div class="detail-content">
                          <span class="detail-label">Due Date</span>
                          <span class="detail-value">
                            {{ formatDate(assignment.dueDate) }}
                            <span class="days-remaining">
                              ({{ getDaysRemaining(assignment.dueDate) >= 0 ? 
                                  getDaysRemaining(assignment.dueDate) + ' days left' : 
                                  Math.abs(getDaysRemaining(assignment.dueDate)) + ' days overdue' }})
                            </span>
                          </span>
                        </div>
                      </div>

                      <div class="detail-item">
                        <mat-icon>help_outline</mat-icon>
                        <div class="detail-content">
                          <span class="detail-label">Questions</span>
                          <span class="detail-value">{{ assignment.numberOfQuestions || 0 }} questions</span>
                        </div>
                      </div>

                      <div class="detail-item" *ngIf="assignment.hasSubmitted && assignment.submissionStatus">
                        <mat-icon>assessment</mat-icon>
                        <div class="detail-content">
                          <span class="detail-label">Your Score</span>
                          <span class="detail-value score-value">
                            {{ assignment.submissionStatus.marks || 0 }}/{{ assignment.totalMarks }} 
                            ({{ assignment.submissionStatus.percentage || 0 }}%)
                          </span>
                        </div>
                      </div>

                      <div class="detail-item" *ngIf="assignment.hasSubmitted && assignment.submissionStatus">
                        <mat-icon>emoji_events</mat-icon>
                        <div class="detail-content">
                          <span class="detail-label">Performance Level</span>
                          <span class="detail-value" [ngClass]="'performance-' + (assignment.submissionStatus.level || 'beginner')">
                            {{ capitalizeFirstLetter(assignment.submissionStatus.level || 'beginner') }}
                          </span>
                        </div>
                      </div>
                    </div>

                    <!-- Related Modules -->
                    <div class="assignment-modules-enhanced" *ngIf="assignment.modules && assignment.modules.length">
                      <div class="modules-header">
                        <mat-icon>book</mat-icon>
                        <span class="modules-label">Related Modules:</span>
                      </div>
                      <mat-chip-set class="modules-chips">
                        <mat-chip *ngFor="let mod of assignment.modules" class="module-chip">
                          <mat-icon>bookmark</mat-icon>
                          Week {{ mod.moduleNumber }}: {{ mod.name }}
                        </mat-chip>
                      </mat-chip-set>
                    </div>

                    <!-- Assignment Actions -->
                    <div class="assignment-actions">
                      <button mat-raised-button color="primary" 
                              *ngIf="!assignment.hasSubmitted && getDaysRemaining(assignment.dueDate) >= 0"
                              [routerLink]="['/student/assignments', assignment._id, 'take']"
                              class="action-button start-button">
                        <mat-icon>play_arrow</mat-icon>
                        Start Assignment
                      </button>
                      
                      <button mat-raised-button color="accent"
                              *ngIf="assignment.hasSubmitted"
                              [routerLink]="['/student/assignments', assignment._id, 'result']"
                              class="action-button result-button">
                        <mat-icon>visibility</mat-icon>
                        View Results
                      </button>

                      <button mat-stroked-button 
                              *ngIf="!assignment.hasSubmitted && getDaysRemaining(assignment.dueDate) < 0"
                              disabled
                              class="action-button overdue-button">
                        <mat-icon>block</mat-icon>
                        Submission Closed
                      </button>

                      <div class="submission-info" *ngIf="assignment.hasSubmitted && assignment.submissionStatus">
                        <mat-icon>check_circle</mat-icon>
                        <span>Submitted on {{ formatDate(assignment.submissionStatus.submittedAt) }}</span>
                      </div>
                    </div>
                  </div>
                </mat-expansion-panel>
              </mat-accordion>
            </div>
            <div *ngIf="!subject.allAssignments || subject.allAssignments.length === 0" class="empty-state">
              <mat-icon>assignment</mat-icon>
              <h3>No Assignments Yet</h3>
              <p>Assignments will appear here once they are created for this subject.</p>
            </div>
          </div>
        </mat-tab>

        <!-- Meetings Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon>video_call</mat-icon>
            <span>Meetings</span>
            <span class="tab-count">{{ subject.allMeetings?.length || 0 }}</span>
          </ng-template>
          <div class="tab-content">
            <mat-accordion *ngIf="subject.allMeetings && subject.allMeetings.length > 0" class="meeting-list">
              <mat-expansion-panel *ngFor="let meeting of subject.allMeetings" 
                [expanded]="true"
                class="meeting-accordion" 
                [ngClass]="{
                  'meeting-scheduled': meeting.status === 'scheduled' && !isMeetingExpired(meeting),
                  'meeting-ongoing': meeting.status === 'ongoing',
                  'meeting-completed': meeting.status === 'completed',
                  'meeting-cancelled': meeting.status === 'cancelled',
                  'meeting-expired': isMeetingExpired(meeting)
                }">
                
                <!-- Accordion Header -->
                <mat-expansion-panel-header class="meeting-accordion-header">
                  <mat-panel-title class="meeting-panel-title">
                    <div class="meeting-title-compact">
                      <mat-icon class="meeting-icon">{{getMeetingStatusIcon(meeting.status, isMeetingExpired(meeting))}}</mat-icon>
                      <div class="meeting-title-content">
                        <h3 class="meeting-title-text">{{ meeting.topic }}</h3>
                        <p class="meeting-subtitle">{{ meeting.description }}</p>
                      </div>
                    </div>
                  </mat-panel-title>
                  
                  <mat-panel-description class="meeting-panel-description">
                    <div class="meeting-quick-info">
                      <!-- Status Badge -->
                      <span class="quick-badge meeting-status-badge" 
                        [ngClass]="isMeetingExpired(meeting) ? 'status-expired' : ('status-' + (meeting.status || 'scheduled'))">
                        <mat-icon>{{isMeetingExpired(meeting) ? 'event_busy' : 
                                     (meeting.status === 'ongoing' ? 'live_tv' : 
                                      meeting.status === 'completed' ? 'check_circle' : 
                                      meeting.status === 'cancelled' ? 'cancel' : 'event')}}</mat-icon>
                        {{ isMeetingExpired(meeting) ? 'Expired' : capitalizeFirstLetter(meeting.status || 'Scheduled') }}
                      </span>
                      
                      <!-- Date Badge -->
                      <span class="quick-info-text">
                        <mat-icon>event</mat-icon>
                        {{ formatMeetingDate(meeting.meetingDate) }}
                      </span>
                      
                      <!-- Time Badge -->
                      <span class="quick-info-text">
                        <mat-icon>schedule</mat-icon>
                        {{ formatMeetingTime(meeting.startTime) }}
                      </span>
                    </div>
                  </mat-panel-description>
                </mat-expansion-panel-header>

                <!-- Accordion Body -->
                <div class="meeting-accordion-body">
                  <!-- Meeting Details Grid -->
                  <div class="meeting-details-grid">
                    <div class="meeting-detail-item">
                      <mat-icon>event</mat-icon>
                      <div class="detail-content">
                        <span class="detail-label">Date</span>
                        <span class="detail-value">{{ formatMeetingDate(meeting.meetingDate) }}</span>
                      </div>
                    </div>

                    <div class="meeting-detail-item">
                      <mat-icon>schedule</mat-icon>
                      <div class="detail-content">
                        <span class="detail-label">Start Time</span>
                        <span class="detail-value">{{ formatMeetingTime(meeting.startTime) }}</span>
                      </div>
                    </div>

                    <div class="meeting-detail-item" *ngIf="meeting.endTime">
                      <mat-icon>schedule</mat-icon>
                      <div class="detail-content">
                        <span class="detail-label">End Time</span>
                        <span class="detail-value">{{ formatMeetingTime(meeting.endTime) }}</span>
                      </div>
                    </div>

                    <div class="meeting-detail-item" *ngIf="meeting.duration">
                      <mat-icon>timer</mat-icon>
                      <div class="detail-content">
                        <span class="detail-label">Duration</span>
                        <span class="detail-value">{{ getMeetingDuration(meeting) }}</span>
                      </div>
                    </div>
                  </div>

                  <!-- Related Modules -->
                  <div class="meeting-modules-section" *ngIf="meeting.modules && meeting.modules.length">
                    <div class="modules-header">
                      <mat-icon>book</mat-icon>
                      <span class="modules-label">Related Modules</span>
                    </div>
                    <mat-chip-set class="modules-chips">
                      <mat-chip *ngFor="let mod of meeting.modules" class="module-chip">
                        <mat-icon>library_books</mat-icon>
                        Week {{ mod.moduleNumber }}: {{ mod.name }}
                      </mat-chip>
                    </mat-chip-set>
                  </div>

                  <!-- Meeting Actions -->
                  <div class="meeting-actions">
                    <!-- Join Button - Show for scheduled and ongoing meetings, hide if expired -->
                    <a *ngIf="meeting.dailyRoomUrl && !isMeetingExpired(meeting) && (meeting.status === 'scheduled' || meeting.status === 'ongoing')" 
                       [href]="meeting.dailyRoomUrl" 
                       target="_blank"
                       mat-raised-button 
                       class="join-meeting-btn"
                       [ngClass]="{
                         'btn-join-now': meeting.status === 'ongoing',
                         'btn-join-scheduled': meeting.status === 'scheduled'
                       }">
                      <mat-icon>video_call</mat-icon>
                      <span>{{ meeting.status === 'ongoing' ? 'Join Now' : 'Join Meeting' }}</span>
                    </a>

                    <!-- Meeting Expired Message -->
                    <div *ngIf="isMeetingExpired(meeting) && meeting.status !== 'completed' && meeting.status !== 'cancelled'" 
                         class="meeting-expired-msg">
                      <mat-icon>event_busy</mat-icon>
                      <span>This meeting has expired</span>
                      <span class="expired-time">
                        Scheduled: {{ formatDateTime(meeting.startTime) }}
                      </span>
                    </div>

                    <!-- Meeting Completed Message -->
                    <div *ngIf="meeting.status === 'completed'" class="meeting-completed-msg">
                      <mat-icon>check_circle</mat-icon>
                      <span>This meeting has ended</span>
                      <span class="completed-time" *ngIf="meeting.endedAt">
                        Ended: {{ formatDateTime(meeting.endedAt) }}
                      </span>
                    </div>

                    <!-- Meeting Cancelled Message -->
                    <div *ngIf="meeting.status === 'cancelled'" class="meeting-cancelled-msg">
                      <mat-icon>cancel</mat-icon>
                      <span>This meeting has been cancelled</span>
                    </div>

                    <!-- Upcoming Meeting Info -->
                    <div *ngIf="!isMeetingExpired(meeting) && meeting.status === 'scheduled' && getMeetingTimeStatus(meeting) === 'upcoming'" 
                         class="meeting-upcoming-msg">
                      <mat-icon>info</mat-icon>
                      <span>{{ getTimeUntilMeeting(meeting) }}</span>
                    </div>
                  </div>
                </div>
              </mat-expansion-panel>
            </mat-accordion>

            <!-- Empty State -->
            <div *ngIf="!subject.allMeetings || subject.allMeetings.length === 0" class="empty-state">
              <mat-icon>video_call</mat-icon>
              <h3>No Meetings Yet</h3>
              <p>Meetings will appear here once they are scheduled for this subject.</p>
            </div>
          </div>
        </mat-tab>

        <!-- Extra Learning Resources Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon>extension</mat-icon>
            <span>Extra Resources</span>
            <span class="tab-count">{{ extraModules.length || 0 }}</span>
          </ng-template>
          <div class="tab-content">
            <!-- Student Level Badge -->
            <div class="student-level-info" *ngIf="studentLevel">
              <mat-chip [ngClass]="getLevelBadgeClass(studentLevel)">
                <mat-icon>trending_up</mat-icon>
                Your Level: {{ capitalizeFirstLetter(studentLevel) }}
              </mat-chip>
              <p class="level-description">
                These extra resources are recommended based on your current performance level in this subject.
              </p>
            </div>

            <!-- Loading State -->
            <div *ngIf="loadingExtraModules" class="loading-container">
              <mat-progress-bar mode="indeterminate"></mat-progress-bar>
              <p>Loading extra resources...</p>
            </div>

            <!-- Extra Modules List -->
            <div *ngIf="!loadingExtraModules && extraModules && extraModules.length > 0">
              <mat-accordion class="modules-accordion" multi>
                <mat-expansion-panel *ngFor="let module of extraModules" class="module-panel extra-module-panel" [expanded]="true">
                  <mat-expansion-panel-header>
                    <mat-panel-title>
                      <div class="module-title">
                        <span class="module-code">{{ module.code }}</span>
                        <span class="module-name">{{ module.name || module.title }}</span>
                      </div>
                    </mat-panel-title>
                    <mat-panel-description>
                      <div class="module-badges">
                        <mat-chip [ngClass]="getLevelBadgeClass(module.studentLevel)">
                          {{ module.studentLevel }}
                        </mat-chip>
                        <mat-chip *ngIf="module.documents && module.documents.length">
                          <mat-icon>picture_as_pdf</mat-icon> {{ module.documents.length }} Doc{{ module.documents.length > 1 ? 's' : '' }}
                        </mat-chip>
                        <mat-chip *ngIf="module.video && module.video.cloudinaryURL">
                          <mat-icon>play_circle</mat-icon> Video
                        </mat-chip>
                      </div>
                    </mat-panel-description>
                  </mat-expansion-panel-header>

                  <!-- Extra Module Body -->
                  <div class="module-body">
                    <p class="module-description">{{ module.description }}</p>

                    <!-- Resources Section -->
                    <div class="resources-section" *ngIf="(module.documents && module.documents.length) || (module.video && module.video.cloudinaryURL)">
                      <h4><mat-icon>folder_open</mat-icon> Resources</h4>
                      <div class="resource-list">
                        <!-- Video Resource (show first if exists) -->
                        <div *ngIf="module.video && module.video.cloudinaryURL" class="resource-item">
                          <button (click)="openVideoPlayer(module.video.cloudinaryURL, module.name + ' - Video')" mat-raised-button color="accent" class="resource-button video">
                            <mat-icon>play_circle</mat-icon>
                            <span>Play Video</span>
                          </button>
                          <a [href]="module.video.cloudinaryURL" download mat-raised-button class="resource-button download">
                            <mat-icon>download</mat-icon>
                            <span>Download</span>
                          </a>
                        </div>
                        
                        <!-- Document Resources -->
                        <div *ngFor="let doc of module.documents || []" class="resource-item">
                          <button (click)="openPdfViewer(doc.cloudinaryURL, doc.name)" mat-raised-button color="primary" class="resource-button doc">
                            <mat-icon>visibility</mat-icon>
                            <span>View {{ doc.name }}</span>
                          </button>
                          <a [href]="doc.cloudinaryURL" download mat-raised-button class="resource-button download">
                            <mat-icon>download</mat-icon>
                            <span>Download</span>
                          </a>
                        </div>
                      </div>
                    </div>

                    <div *ngIf="(!module.documents || !module.documents.length) && (!module.video || !module.video.cloudinaryURL)" class="no-resources">
                      <mat-icon>info</mat-icon>
                      <p>No resources available for this extra module yet.</p>
                    </div>
                  </div>
                </mat-expansion-panel>
              </mat-accordion>
            </div>

            <!-- Empty State -->
            <div *ngIf="!loadingExtraModules && (!extraModules || extraModules.length === 0)" class="empty-state">
              <mat-icon>extension</mat-icon>
              <h3>No Extra Resources Yet</h3>
              <p>Extra learning resources for your level ({{ capitalizeFirstLetter(studentLevel) }}) will appear here once they are added.</p>
              <p class="hint">Keep completing assignments to improve your level and unlock more resources!</p>
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>
    </div>

    <!-- Error State -->
    <div *ngIf="!isLoading && !subject" class="error-state">
      <mat-card>
        <mat-icon>error_outline</mat-icon>
        <h2>Subject Not Found</h2>
        <p>We couldn't find the subject you're looking for.</p>
        <button mat-raised-button color="primary" routerLink="/student/subjects">
          <mat-icon>arrow_back</mat-icon>
          Back to Subjects
        </button>
      </mat-card>
    </div>
  </div>
</app-student-layout>
