<div class="dialog-container">
  <div class="dialog-header">
    <div class="header-content">
      <div class="header-icon">
        <mat-icon>{{ isEditMode ? 'edit_calendar' : 'video_call' }}</mat-icon>
      </div>
      <div class="header-text">
        <h2 mat-dialog-title>{{ isEditMode ? 'Edit Meeting' : 'Create New Meeting' }}</h2>
        <p class="header-subtitle" *ngIf="!isEditMode">Schedule a video meeting for your students</p>
      </div>
    </div>
    <button mat-icon-button mat-dialog-close class="close-button">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div mat-dialog-content class="dialog-content">
    <form [formGroup]="meetingForm" class="meeting-form">
      
      <!-- Basic Information Section -->
      <div class="form-section">
        <div class="section-header">
          <mat-icon>info</mat-icon>
          <h3>Basic Information</h3>
          <span class="required-badge">Required</span>
        </div>
        
        <div class="form-grid">
          <mat-form-field appearance="outline" class="form-field full-width">
            <mat-label>Meeting Topic</mat-label>
            <mat-icon matPrefix>topic</mat-icon>
            <input matInput formControlName="topic" placeholder="Enter meeting topic">
            <mat-error *ngIf="meetingForm.get('topic')?.hasError('required')">
              Topic is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field full-width">
            <mat-label>Meeting Description</mat-label>
            <mat-icon matPrefix>description</mat-icon>
            <textarea matInput formControlName="description" rows="3" 
                      placeholder="Enter meeting description"></textarea>
            <mat-error *ngIf="meetingForm.get('description')?.hasError('required')">
              Description is required
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Subject Selection for Lecturers -->
      <div class="form-section" *ngIf="data.lecturerId">
        <div class="section-header">
          <mat-icon>book</mat-icon>
          <h3>Subject Selection</h3>
          <span class="required-badge">Required</span>
        </div>
        
        <div class="form-grid">
          <mat-form-field appearance="outline" class="form-field full-width">
            <mat-label>Subject</mat-label>
            <mat-icon matPrefix>subject</mat-icon>
            <mat-select formControlName="subjectId" (selectionChange)="onSubjectChange()">
              <mat-option *ngFor="let subject of subjects" [value]="subject._id">
                {{ subject.name }} ({{ subject.code }})
              </mat-option>
            </mat-select>
            <mat-error *ngIf="meetingForm.get('subjectId')?.hasError('required')">
              Subject is required
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Auto-populated Info Panel -->
        <div class="auto-populated-info" *ngIf="meetingForm.get('subjectId')?.value">
          <div class="info-header">
            <mat-icon>auto_awesome</mat-icon>
            <h4>Auto-populated Information</h4>
          </div>
          <div class="info-grid">
            <div class="info-item">
              <label>Department</label>
              <span>{{ getSelectedSubjectInfo('department') }}</span>
            </div>
            <div class="info-item">
              <label>Course</label>
              <span>{{ getSelectedSubjectInfo('course') }}</span>
            </div>
            <div class="info-item">
              <label>Batch</label>
              <span>{{ getSelectedSubjectInfo('batch') }}</span>
            </div>
            <div class="info-item">
              <label>Semester</label>
              <span>{{ getSelectedSubjectInfo('semester') }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Academic Structure for Admin -->
      <div class="form-section" *ngIf="!data.lecturerId">
        <div class="section-header">
          <mat-icon>account_tree</mat-icon>
          <h3>Academic Structure</h3>
          <span class="required-badge">Required</span>
        </div>
        
        <div class="form-grid">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Department</mat-label>
            <mat-icon matPrefix>business</mat-icon>
            <mat-select formControlName="departmentId" (selectionChange)="onDepartmentChange()">
              <mat-option *ngFor="let dept of departments" [value]="dept._id">
                {{ dept.name }} ({{ dept.code }})
              </mat-option>
            </mat-select>
            <mat-error *ngIf="meetingForm.get('departmentId')?.hasError('required')">
              Department is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Course</mat-label>
            <mat-icon matPrefix>menu_book</mat-icon>
            <mat-select formControlName="courseId" (selectionChange)="onCourseChange()">
              <mat-option *ngFor="let course of courses" [value]="course._id">
                {{ course.name }} ({{ course.code }})
              </mat-option>
            </mat-select>
            <mat-hint *ngIf="!meetingForm.get('departmentId')?.value" class="info-hint">
              <mat-icon>info</mat-icon> Select department first
            </mat-hint>
            <mat-error *ngIf="meetingForm.get('courseId')?.hasError('required')">
              Course is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Batch</mat-label>
            <mat-icon matPrefix>groups</mat-icon>
            <mat-select formControlName="batchId" (selectionChange)="onBatchChange()">
              <mat-option *ngFor="let batch of batches" [value]="batch._id">
                {{ batch.name }} - {{ batch.year }}
              </mat-option>
            </mat-select>
            <mat-hint *ngIf="!meetingForm.get('courseId')?.value" class="info-hint">
              <mat-icon>info</mat-icon> Select course first
            </mat-hint>
            <mat-error *ngIf="meetingForm.get('batchId')?.hasError('required')">
              Batch is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Semester</mat-label>
            <mat-icon matPrefix>event_note</mat-icon>
            <mat-select formControlName="semesterId" (selectionChange)="onSemesterChange()">
              <mat-option *ngFor="let semester of semesters" [value]="semester._id">
                {{ semester.name }}
              </mat-option>
            </mat-select>
            <mat-hint *ngIf="!meetingForm.get('batchId')?.value" class="info-hint">
              <mat-icon>info</mat-icon> Select batch first
            </mat-hint>
            <mat-error *ngIf="meetingForm.get('semesterId')?.hasError('required')">
              Semester is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field full-width">
            <mat-label>Subject</mat-label>
            <mat-icon matPrefix>subject</mat-icon>
            <mat-select formControlName="subjectId" (selectionChange)="onSubjectChange()">
              <mat-option *ngFor="let subject of subjects" [value]="subject._id">
                {{ subject.name }} ({{ subject.code }})
              </mat-option>
            </mat-select>
            <mat-hint *ngIf="!meetingForm.get('semesterId')?.value" class="info-hint">
              <mat-icon>info</mat-icon> Select semester first
            </mat-hint>
            <mat-error *ngIf="meetingForm.get('subjectId')?.hasError('required')">
              Subject is required
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Additional Information Section -->
      <div class="form-section">
        <div class="section-header">
          <mat-icon>people</mat-icon>
          <h3>Meeting Details</h3>
        </div>
        
        <div class="form-grid">
          <mat-form-field appearance="outline" class="form-field" *ngIf="lecturerInfo">
            <mat-label>Meeting Incharge</mat-label>
            <mat-icon matPrefix>person</mat-icon>
            <input matInput [value]="lecturerInfo" readonly>
            <mat-hint>Subject Lecturer</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Max Students</mat-label>
            <mat-icon matPrefix>groups</mat-icon>
            <input matInput formControlName="studentCount" readonly>
            <mat-hint>Automatically fetched from batch</mat-hint>
          </mat-form-field>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Module Selection -->
      <div class="form-section" *ngIf="modules.length > 0">
        <div class="section-header">
          <mat-icon>view_module</mat-icon>
          <h3>Select Module(s)</h3>
          <span class="required-badge">Required</span>
        </div>
        
        <div class="module-list">
          <div class="module-checkbox-wrapper" *ngFor="let module of modules">
            <mat-checkbox 
              [checked]="isModuleSelected(module._id)"
              (change)="onModuleToggle(module._id, $event.checked)"
              class="module-checkbox">
              <div class="module-info">
                <div class="module-header">
                  <strong>{{ module.name }}</strong>
                  <span class="module-code">{{ module.code }}</span>
                </div>
                <small>{{ module.title }}</small>
              </div>
            </mat-checkbox>
          </div>
        </div>
        
        <div class="error-message" *ngIf="selectedModules.length === 0 && formSubmitted">
          <mat-icon>error</mat-icon>
          Please select at least one module
        </div>
      </div>

      <div class="divider"></div>

      <!-- Schedule Information Section -->
      <div class="form-section">
        <div class="section-header">
          <mat-icon>schedule</mat-icon>
          <h3>Schedule Information</h3>
          <span class="required-badge">Required</span>
        </div>
        
        <div class="form-grid">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Meeting Date</mat-label>
            <mat-icon matPrefix>calendar_today</mat-icon>
            <input matInput 
                   [matDatepicker]="picker" 
                   formControlName="meetingDate" 
                   [min]="minDate" 
                   (dateChange)="calculateEndTime()"
                   placeholder="Select meeting date">
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
            <mat-error *ngIf="meetingForm.get('meetingDate')?.hasError('required')">
              Meeting date is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Start Time</mat-label>
            <mat-icon matPrefix>access_time</mat-icon>
            <input matInput type="time" formControlName="startTime" 
                   (change)="calculateEndTime()">
            <mat-error *ngIf="meetingForm.get('startTime')?.hasError('required')">
              Start time is required
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Duration (minutes)</mat-label>
            <mat-icon matPrefix>timer</mat-icon>
            <input matInput type="number" formControlName="duration" 
                   placeholder="60" min="1" max="480" 
                   (input)="calculateEndTime()">
            <mat-hint>Max 480 minutes (8 hours)</mat-hint>
            <mat-error *ngIf="meetingForm.get('duration')?.hasError('required')">
              Duration is required
            </mat-error>
            <mat-error *ngIf="meetingForm.get('duration')?.hasError('min')">
              Duration must be at least 1 minute
            </mat-error>
            <mat-error *ngIf="meetingForm.get('duration')?.hasError('max')">
              Duration cannot exceed 480 minutes
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field" *ngIf="calculatedEndTime">
            <mat-label>End Time (Calculated)</mat-label>
            <mat-icon matPrefix>event</mat-icon>
            <input matInput [value]="calculatedEndTime" readonly>
            <mat-hint>Automatically calculated</mat-hint>
          </mat-form-field>
        </div>
      </div>

    </form>
  </div>

  <div mat-dialog-actions class="dialog-actions">
    <div class="left-actions">
      <button mat-stroked-button type="button" (click)="onCancel()" [disabled]="loading">
        <mat-icon>close</mat-icon>
        Cancel
      </button>
    </div>
    <div class="right-actions">
      <button 
        mat-raised-button 
        color="primary" 
        type="submit" 
        (click)="onSubmit()"
        [disabled]="loading || meetingForm.invalid || selectedModules.length === 0">
        <mat-spinner *ngIf="loading" diameter="20" class="button-spinner"></mat-spinner>
        <mat-icon *ngIf="!loading">{{ isEditMode ? 'save' : 'video_call' }}</mat-icon>
        {{ isEditMode ? 'Update Meeting' : 'Create Meeting' }}
      </button>
    </div>
  </div>
</div>
