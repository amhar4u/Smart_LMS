<div class="dialog-container">
  <div class="dialog-header">
    <div class="header-content">
      <div class="header-icon">
        <mat-icon>{{ data.mode === 'create' ? 'add_box' : 'edit_note' }}</mat-icon>
      </div>
      <div class="header-text">
        <h2 mat-dialog-title>{{ dialogTitle }}</h2>
        <p class="header-subtitle" *ngIf="data.mode === 'create'">Create supplementary learning materials for students</p>
      </div>
    </div>
    <button mat-icon-button mat-dialog-close class="close-button">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <mat-dialog-content class="dialog-content">
    <form [formGroup]="extraModuleForm" class="extra-module-form">
      
      <!-- Basic Information Section -->
      <div class="form-section">
        <div class="section-header">
          <mat-icon>info</mat-icon>
          <h3>Basic Information</h3>
          <span class="required-badge">Required</span>
        </div>
        
        <div class="form-grid">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Module Title</mat-label>
            <mat-icon matPrefix>title</mat-icon>
            <input matInput formControlName="title" placeholder="Enter module title">
            <mat-error>{{ getErrorMessage('title') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Module Name</mat-label>
            <mat-icon matPrefix>label</mat-icon>
            <input matInput formControlName="name" placeholder="Enter module name">
            <mat-error>{{ getErrorMessage('name') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Module Code</mat-label>
            <mat-icon matPrefix>tag</mat-icon>
            <input matInput formControlName="code" placeholder="Enter module code" style="text-transform: uppercase;">
            <mat-error>{{ getErrorMessage('code') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Order</mat-label>
            <mat-icon matPrefix>sort</mat-icon>
            <input matInput formControlName="order" type="number" min="1" placeholder="Enter module order">
            <mat-error>{{ getErrorMessage('order') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field full-width">
            <mat-label>Description</mat-label>
            <mat-icon matPrefix>description</mat-icon>
            <textarea matInput formControlName="description" rows="3" placeholder="Enter module description"></textarea>
            <mat-error>{{ getErrorMessage('description') }}</mat-error>
          </mat-form-field>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Lecturer Mode: Subject Selection -->
      <div class="form-section" *ngIf="data.lecturerId">
        <div class="section-header">
          <mat-icon>book</mat-icon>
          <h3>Subject Selection</h3>
          <span class="required-badge">Required</span>
        </div>
        
        <div class="form-grid">
          <mat-form-field appearance="outline" class="form-field full-width">
            <mat-label>Subject</mat-label>
            <mat-icon matPrefix>subject</mat-icon>
            <mat-select formControlName="subjectId" required (selectionChange)="onSubjectChange($event.value)">
              <mat-option *ngFor="let subject of subjects" [value]="subject._id">
                {{ subject.name }} ({{ subject.code }})
              </mat-option>
            </mat-select>
            <mat-hint>Select your subject - other details will be auto-populated</mat-hint>
            <mat-error>{{ getErrorMessage('subjectId') }}</mat-error>
          </mat-form-field>
        </div>

        <!-- Auto-populated Info Panel -->
        <div class="auto-populated-info" *ngIf="extraModuleForm.get('subjectId')?.value">
          <div class="info-header">
            <mat-icon>auto_awesome</mat-icon>
            <h4>Auto-populated Information</h4>
          </div>
          <div class="info-grid">
            <div class="info-item">
              <label>Department</label>
              <span>{{ getSelectedSubjectInfo('department') }}</span>
            </div>
            <div class="info-item">
              <label>Course</label>
              <span>{{ getSelectedSubjectInfo('course') }}</span>
            </div>
            <div class="info-item">
              <label>Batch</label>
              <span>{{ getSelectedSubjectInfo('batch') }}</span>
            </div>
            <div class="info-item">
              <label>Semester</label>
              <span>{{ getSelectedSubjectInfo('semester') }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="divider" *ngIf="data.lecturerId"></div>

      <!-- Student Level Section (Lecturer Mode) -->
      <div class="form-section" *ngIf="data.lecturerId">
        <div class="section-header">
          <mat-icon>trending_up</mat-icon>
          <h3>Difficulty Level</h3>
          <span class="required-badge">Required</span>
        </div>
        
        <div class="form-grid">
          <mat-form-field appearance="outline" class="form-field full-width">
            <mat-label>Student Level</mat-label>
            <mat-icon matPrefix>school</mat-icon>
            <mat-select formControlName="studentLevel" required>
              <mat-option *ngFor="let level of studentLevels" [value]="level">
                <div class="level-option">
                  <mat-icon [style.color]="getStudentLevelColor(level)">
                    {{ level === 'Beginner' ? 'school' : level === 'Intermediate' ? 'trending_up' : level === 'Advanced' ? 'military_tech' : 'groups' }}
                  </mat-icon>
                  <span>{{ level }}</span>
                </div>
              </mat-option>
            </mat-select>
            <mat-hint>Select the appropriate difficulty level for students</mat-hint>
            <mat-error>{{ getErrorMessage('studentLevel') }}</mat-error>
          </mat-form-field>
        </div>
      </div>

      <div class="divider" *ngIf="data.lecturerId"></div>

      <!-- Admin Mode: Academic Structure -->
      <div class="form-section" *ngIf="!data.lecturerId">
        <div class="section-header">
          <mat-icon>account_tree</mat-icon>
          <h3>Academic Structure</h3>
          <span class="required-badge">Required</span>
        </div>
        
        <div class="form-grid">
          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Department</mat-label>
            <mat-icon matPrefix>business</mat-icon>
            <mat-select formControlName="department" required (selectionChange)="onDepartmentChange($event.value)">
              <mat-option *ngFor="let department of departments" [value]="department._id">
                {{ department.name }} ({{ department.code }})
              </mat-option>
            </mat-select>
            <mat-hint>Select department to filter courses</mat-hint>
            <mat-error>{{ getErrorMessage('department') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Course</mat-label>
            <mat-icon matPrefix>menu_book</mat-icon>
            <mat-select formControlName="course" required (selectionChange)="onCourseChange($event.value)" [disabled]="!courses.length">
              <mat-option *ngFor="let course of courses" [value]="course._id">
                {{ course.name }} ({{ course.code }})
              </mat-option>
            </mat-select>
            <mat-hint *ngIf="!extraModuleForm.get('department')?.value" class="info-hint">
              <mat-icon>info</mat-icon> Select department first
            </mat-hint>
            <mat-error>{{ getErrorMessage('course') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Batch</mat-label>
            <mat-icon matPrefix>groups</mat-icon>
            <mat-select formControlName="batch" required (selectionChange)="onBatchChange($event.value)" [disabled]="!batches.length">
              <mat-option *ngFor="let batch of batches" [value]="batch._id">
                {{ batch.name }} ({{ batch.code }})
              </mat-option>
            </mat-select>
            <mat-hint *ngIf="!extraModuleForm.get('course')?.value" class="info-hint">
              <mat-icon>info</mat-icon> Select course first
            </mat-hint>
            <mat-error>{{ getErrorMessage('batch') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Semester</mat-label>
            <mat-icon matPrefix>event_note</mat-icon>
            <mat-select formControlName="semester" required (selectionChange)="onSemesterChange($event.value)" [disabled]="!semesters.length">
              <mat-option *ngFor="let semester of semesters" [value]="semester._id">
                {{ semester.name }} - {{ semester.year }}
              </mat-option>
            </mat-select>
            <mat-hint *ngIf="!extraModuleForm.get('batch')?.value" class="info-hint">
              <mat-icon>info</mat-icon> Select batch first
            </mat-hint>
            <mat-error>{{ getErrorMessage('semester') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Subject</mat-label>
            <mat-icon matPrefix>subject</mat-icon>
            <mat-select formControlName="subjectId" required [disabled]="!subjects.length">
              <mat-option *ngFor="let subject of subjects" [value]="subject._id">
                {{ subject.name }} ({{ subject.code }})
              </mat-option>
            </mat-select>
            <mat-hint *ngIf="!extraModuleForm.get('semester')?.value" class="info-hint">
              <mat-icon>info</mat-icon> Select semester first
            </mat-hint>
            <mat-error>{{ getErrorMessage('subjectId') }}</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field">
            <mat-label>Student Level</mat-label>
            <mat-icon matPrefix>school</mat-icon>
            <mat-select formControlName="studentLevel" required>
              <mat-option *ngFor="let level of studentLevels" [value]="level">
                <div class="level-option">
                  <mat-icon [style.color]="getStudentLevelColor(level)">
                    {{ level === 'Beginner' ? 'school' : level === 'Intermediate' ? 'trending_up' : level === 'Advanced' ? 'military_tech' : 'groups' }}
                  </mat-icon>
                  <span>{{ level }}</span>
                </div>
              </mat-option>
            </mat-select>
            <mat-hint>Select the appropriate difficulty level</mat-hint>
            <mat-error>{{ getErrorMessage('studentLevel') }}</mat-error>
          </mat-form-field>
        </div>
      </div>

      <div class="divider" *ngIf="!data.lecturerId"></div>

      <!-- Module Status Section -->
      <div class="form-section">
        <div class="section-header">
          <mat-icon>settings</mat-icon>
          <h3>Module Status</h3>
        </div>
        
        <div class="status-checkbox">
          <mat-checkbox formControlName="isActive" color="primary">
            <div class="checkbox-content">
              <strong>Active Module</strong>
              <span>Inactive modules will not be visible to students</span>
            </div>
          </mat-checkbox>
        </div>
      </div>

      <div class="divider"></div>

      <!-- File Upload Sections -->
      <div class="form-section">
        <div class="section-header">
          <mat-icon>cloud_upload</mat-icon>
          <h3>Learning Materials</h3>
          <span class="required-badge">Documents Required</span>
        </div>
        
        <!-- Documents Upload -->
        <div class="upload-subsection">
          <div class="subsection-title">
            <mat-icon>picture_as_pdf</mat-icon>
            <h4>PDF Documents</h4>
          </div>
          
          <!-- Existing Documents (Edit Mode) -->
          <div *ngIf="data.mode === 'edit' && data.extraModule?.documents?.length" class="existing-files">
            <h4>Current Documents ({{ data.extraModule?.documents?.length }})</h4>
            <div class="file-list">
              <div *ngFor="let document of data.extraModule?.documents; let i = index" class="file-item existing">
                <mat-icon class="file-icon">picture_as_pdf</mat-icon>
                <div class="file-info">
                  <div class="file-name">{{ document.name }}</div>
                  <div class="file-size">{{ formatFileSize(document.size || 0) }}</div>
                  <div class="file-date">Uploaded: {{ document.uploadedAt | date:'short' }}</div>
                </div>
                <div class="file-actions">
                  <button mat-icon-button color="primary" type="button" 
                          (click)="viewDocument(document)" 
                          matTooltip="View Document">
                    <mat-icon>visibility</mat-icon>
                  </button>
                  <button mat-icon-button color="accent" type="button" 
                          (click)="downloadDocument(document)" 
                          matTooltip="Download Document">
                    <mat-icon>download</mat-icon>
                  </button>
                  <button mat-icon-button color="warn" type="button" 
                          (click)="removeDocument(i)" 
                          matTooltip="Remove Document"
                          [disabled]="(data.extraModule?.documents?.length || 0) === 1 && selectedDocuments.length === 0">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
            </div>
            <mat-divider class="section-divider"></mat-divider>
          </div>
          
          <div class="upload-area" [class.has-files]="selectedDocuments.length > 0">
            <div class="upload-content">
              <mat-icon class="upload-icon">cloud_upload</mat-icon>
              <h4>Upload PDF Documents</h4>
              <p>Drag and drop PDF files here, or click to select files</p>
              <button mat-raised-button color="primary" type="button" (click)="documentInput.click()">
                <mat-icon>add</mat-icon>
                Choose Files
              </button>
              <input #documentInput type="file" multiple accept="application/pdf" 
                     (change)="onDocumentSelect($event)" style="display: none;">
            </div>
          </div>

          <div *ngIf="selectedDocuments.length > 0" class="selected-files">
            <h4>New Documents to Upload ({{ selectedDocuments.length }})</h4>
            <div class="file-list">
              <div *ngFor="let file of selectedDocuments; let i = index" class="file-item new">
                <mat-icon class="file-icon">picture_as_pdf</mat-icon>
                <div class="file-info">
                  <div class="file-name">{{ file.name }}</div>
                  <div class="file-size">{{ formatFileSize(file.size) }}</div>
                </div>
                <button mat-icon-button color="warn" type="button" (click)="removeDocument(i)">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Video Upload -->
        <div class="upload-subsection">
          <div class="subsection-title">
            <mat-icon>videocam</mat-icon>
            <h4>Video Content (Optional)</h4>
          </div>
          
          <!-- Existing Video (Edit Mode) -->
          <div *ngIf="data.mode === 'edit' && data.extraModule?.video" class="existing-files">
            <h4>Current Video</h4>
            <div class="file-list">
              <div class="file-item existing">
                <mat-icon class="file-icon">movie</mat-icon>
                <div class="file-info">
                  <div class="file-name">{{ data.extraModule?.video?.name }}</div>
                  <div class="file-date">Uploaded: {{ data.extraModule?.video?.uploadedAt | date:'short' }}</div>
                  <div *ngIf="data.extraModule?.video?.duration" class="file-duration">Duration: {{ data.extraModule?.video?.duration }}s</div>
                </div>
                <div class="file-actions">
                  <button mat-icon-button color="primary" type="button" 
                          (click)="playVideo()" 
                          matTooltip="Play Video">
                    <mat-icon>play_circle</mat-icon>
                  </button>
                  <button mat-icon-button color="accent" type="button" 
                          (click)="downloadVideo()" 
                          matTooltip="Download Video">
                    <mat-icon>download</mat-icon>
                  </button>
                  <button mat-icon-button color="warn" type="button" 
                          (click)="removeVideo()" 
                          matTooltip="Remove Video">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
            </div>
            <mat-divider class="section-divider"></mat-divider>
          </div>
          
          <div class="upload-area" [class.has-files]="selectedVideo">
            <div class="upload-content">
              <mat-icon class="upload-icon">video_library</mat-icon>
              <h4>Upload Video File</h4>
              <p>Upload a video file for this module (Max 100MB)</p>
              <button mat-raised-button color="accent" type="button" (click)="videoInput.click()">
                <mat-icon>video_call</mat-icon>
                Choose Video
              </button>
              <input #videoInput type="file" accept="video/*" 
                     (change)="onVideoSelect($event)" style="display: none;">
            </div>
          </div>

          <div *ngIf="selectedVideo" class="selected-files">
            <h4>Selected Video</h4>
            <div class="file-list">
              <div class="file-item">
                <mat-icon class="file-icon" style="color: #ff9800;">play_circle</mat-icon>
                <div class="file-info">
                  <div class="file-name">{{ selectedVideo.name }}</div>
                  <div class="file-size">{{ formatFileSize(selectedVideo.size) }}</div>
                </div>
                <button mat-icon-button color="warn" type="button" (click)="removeVideo()">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Upload Progress -->
      <div *ngIf="uploading" class="upload-progress-section">
        <mat-progress-bar mode="indeterminate" color="primary"></mat-progress-bar>
        <div class="progress-text">
          <mat-icon>cloud_upload</mat-icon>
          <p>{{ submitButtonText }}</p>
        </div>
      </div>
    </form>
  </mat-dialog-content>

  <mat-dialog-actions class="dialog-actions">
    <div class="left-actions">
      <button mat-stroked-button type="button" (click)="onCancel()" [disabled]="loading">
        <mat-icon>close</mat-icon>
        Cancel
      </button>
    </div>
    <div class="right-actions">
      <button mat-raised-button color="primary" (click)="onSubmit()" 
              [disabled]="extraModuleForm.invalid || loading">
        <mat-spinner *ngIf="loading" diameter="20" class="button-spinner"></mat-spinner>
        <mat-icon *ngIf="!loading">{{ data.mode === 'create' ? 'add_circle' : 'save' }}</mat-icon>
        {{ submitButtonText }}
      </button>
    </div>
  </mat-dialog-actions>
</div>
