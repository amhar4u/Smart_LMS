<div class="dialog-container">
  <div class="dialog-header">
    <h2 mat-dialog-title>
      <mat-icon>{{ data.mode === 'create' ? 'add' : 'edit' }}</mat-icon>
      {{ dialogTitle }}
    </h2>
  </div>

  <mat-dialog-content class="dialog-content">
    <form [formGroup]="moduleForm" class="module-form">
      <!-- Basic Information -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Module Name *</mat-label>
          <input matInput formControlName="name" placeholder="Enter module name">
          <mat-error>{{ getErrorMessage('name') }}</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Module Code *</mat-label>
          <input matInput formControlName="code" placeholder="Enter module code" style="text-transform: uppercase;">
          <mat-error>{{ getErrorMessage('code') }}</mat-error>
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Description *</mat-label>
        <textarea matInput formControlName="description" rows="3" placeholder="Enter module description"></textarea>
        <mat-error>{{ getErrorMessage('description') }}</mat-error>
      </mat-form-field>

      <!-- Hierarchical Selection -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Department *</mat-label>
          <mat-select formControlName="department" required (selectionChange)="onDepartmentChange($event.value)">
            <mat-option *ngFor="let department of departments" [value]="department._id">
              {{ department.name }} ({{ department.code }})
            </mat-option>
          </mat-select>
          <mat-error>{{ getErrorMessage('department') }}</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Course *</mat-label>
          <mat-select formControlName="course" required (selectionChange)="onCourseChange($event.value)" [disabled]="!courses.length">
            <mat-option *ngFor="let course of courses" [value]="course._id">
              {{ course.name }} ({{ course.code }})
            </mat-option>
          </mat-select>
          <mat-error>{{ getErrorMessage('course') }}</mat-error>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Batch *</mat-label>
          <mat-select formControlName="batch" required (selectionChange)="onBatchChange($event.value)" [disabled]="!batches.length">
            <mat-option *ngFor="let batch of batches" [value]="batch._id">
              {{ batch.name }} ({{ batch.code }})
            </mat-option>
          </mat-select>
          <mat-error>{{ getErrorMessage('batch') }}</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Semester *</mat-label>
          <mat-select formControlName="semester" required (selectionChange)="onSemesterChange($event.value)" [disabled]="!semesters.length">
            <mat-option *ngFor="let semester of semesters" [value]="semester._id">
              {{ semester.name }} - {{ semester.year }}
            </mat-option>
          </mat-select>
          <mat-error>{{ getErrorMessage('semester') }}</mat-error>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Subject *</mat-label>
          <mat-select formControlName="subject" required [disabled]="!subjects.length">
            <mat-option *ngFor="let subject of subjects" [value]="subject._id">
              {{ subject.name }} ({{ subject.code }})
            </mat-option>
          </mat-select>
          <mat-error>{{ getErrorMessage('subject') }}</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Order *</mat-label>
          <input matInput formControlName="order" type="number" min="1" placeholder="Enter module order">
          <mat-error>{{ getErrorMessage('order') }}</mat-error>
        </mat-form-field>
      </div>

      <div class="checkbox-container">
        <mat-checkbox formControlName="isActive" color="primary">
          Active Module
        </mat-checkbox>
        <div class="checkbox-hint">
          Inactive modules will not be visible to students
        </div>
      </div>

      <mat-divider></mat-divider>

      <!-- File Upload Sections -->
      <div class="upload-sections">
        <!-- Documents Upload -->
        <div class="upload-section">
          <h3 class="section-title">
            <mat-icon>description</mat-icon>
            Documents (PDFs)
          </h3>
          
          <div class="upload-area" [class.has-files]="selectedDocuments.length > 0">
            <div class="upload-content">
              <mat-icon class="upload-icon">cloud_upload</mat-icon>
              <h4>Upload PDF Documents</h4>
              <p>Drag and drop PDF files here, or click to select files</p>
              <button mat-raised-button color="primary" type="button" (click)="documentInput.click()">
                <mat-icon>add</mat-icon>
                Choose Files
              </button>
              <input #documentInput type="file" multiple accept="application/pdf" 
                     (change)="onDocumentSelect($event)" style="display: none;">
            </div>
          </div>

          <div *ngIf="selectedDocuments.length > 0" class="selected-files">
            <h4>Selected Documents ({{ selectedDocuments.length }})</h4>
            <div class="file-list">
              <div *ngFor="let file of selectedDocuments; let i = index" class="file-item">
                <mat-icon class="file-icon">picture_as_pdf</mat-icon>
                <div class="file-info">
                  <div class="file-name">{{ file.name }}</div>
                  <div class="file-size">{{ formatFileSize(file.size) }}</div>
                </div>
                <button mat-icon-button color="warn" type="button" (click)="removeDocument(i)">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </div>
          </div>
        </div>

        <mat-divider></mat-divider>

        <!-- Video Upload -->
        <div class="upload-section">
          <h3 class="section-title">
            <mat-icon>videocam</mat-icon>
            Video (Optional)
          </h3>
          
          <div class="upload-area" [class.has-files]="selectedVideo">
            <div class="upload-content">
              <mat-icon class="upload-icon">video_library</mat-icon>
              <h4>Upload Video File</h4>
              <p>Upload a video file for this module (Max 100MB)</p>
              <button mat-raised-button color="accent" type="button" (click)="videoInput.click()">
                <mat-icon>video_call</mat-icon>
                Choose Video
              </button>
              <input #videoInput type="file" accept="video/*" 
                     (change)="onVideoSelect($event)" style="display: none;">
            </div>
          </div>

          <div *ngIf="selectedVideo" class="selected-files">
            <h4>Selected Video</h4>
            <div class="file-list">
              <div class="file-item">
                <mat-icon class="file-icon" style="color: #ff9800;">play_circle</mat-icon>
                <div class="file-info">
                  <div class="file-name">{{ selectedVideo.name }}</div>
                  <div class="file-size">{{ formatFileSize(selectedVideo.size) }}</div>
                </div>
                <button mat-icon-button color="warn" type="button" (click)="removeVideo()">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Upload Progress -->
      <div *ngIf="uploading" class="upload-progress">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        <p>{{ submitButtonText }}</p>
      </div>
    </form>
  </mat-dialog-content>

  <mat-dialog-actions class="dialog-actions">
    <button mat-button type="button" (click)="onCancel()" [disabled]="loading">
      <mat-icon>cancel</mat-icon>
      Cancel
    </button>
    <button mat-raised-button color="primary" (click)="onSubmit()" 
            [disabled]="moduleForm.invalid || loading">
      <mat-icon>{{ data.mode === 'create' ? 'add' : 'save' }}</mat-icon>
      {{ submitButtonText }}
    </button>
  </mat-dialog-actions>
</div>
